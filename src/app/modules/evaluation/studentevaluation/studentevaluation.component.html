<div style="padding:15px 15px 10px 15px;">
    <div><strong>Execute Evaluation</strong></div>
</div>
<mat-spinner *ngIf="PageLoading" diameter="25" style="position:relative;margin-left: 50%;"></mat-spinner>
<div style="width: 100%;">
    <form [formGroup]="searchForm">
        <mat-form-field appearance="outline" [style.width.px]="200">
            <mat-label>Evaluation type</mat-label>
            <mat-select formControlName="searchEvaluationMasterId" (selectionChange)="GetAttribute()">
                <mat-option *ngFor="let item of EvaluationMaster" [value]="item.EvaluationMasterId">
                    {{item.EvaluationName}}
                </mat-option>
            </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" [style.width.px]="300">
            <mat-label>Student</mat-label>
            <input type="text" matInput formControlName="searchStudentName" [matAutocomplete]="auto">
            <mat-autocomplete (optionSelected)="GetSubjects($event)" #auto="matAutocomplete" [displayWith]="displayFn">
                <mat-option *ngFor="let option of filteredStudents | async" [value]="option">
                    {{option.Name}}
                </mat-option>
            </mat-autocomplete>
        </mat-form-field>
        <button [disabled]="loading" mat-raised-button color="accent" (click)="GetEvaluationMapping()">
            <mat-icon>search</mat-icon>
            <mat-icon *ngIf="loading">
                <mat-spinner diameter="20" color="Blue"></mat-spinner>
            </mat-icon>
        </button>
    </form>
    <mat-table #table [dataSource]="AssessmentTypeDatasource" *ngIf="RelevantEvaluationListForSelectedStudent.length>0">
        <ng-container matColumnDef="ExamName">
            <mat-header-cell *matHeaderCellDef>Exam/Test/Session
            </mat-header-cell>
            <mat-cell *matCellDef="let element">
                {{element.ExamName}}
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="EvaluationName">
            <mat-header-cell *matHeaderCellDef>Evaluation type
            </mat-header-cell>
            <mat-cell *matCellDef="let element">
                {{element.EvaluationName}}
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="ClassGroupName">
            <mat-header-cell *matHeaderCellDef>Class Group
            </mat-header-cell>
            <mat-cell *matCellDef="let element">
                {{element.ClassGroupName}}
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="Action1">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let element">
                <button style="margin-right: 15px;"
                    [disabled]="loading || !element.Action1 || Permission=='read' || EvaluationStarted"
                    matTooltip="start" mat-mini-fab color="accent" (click)="StartEvaluation(element)">
                    <mat-icon>start</mat-icon>
                </button>
                <button [disabled]="loading || !element.Action1 
                    || Permission=='read' 
                    || EvaluationSubmitted 
                    || !EvaluationStarted
                    || AlreadyAnswered" matTooltip="save as draft" mat-mini-fab color="accent" (click)="SaveAsDraft()">
                    <mat-icon>edit</mat-icon>
                    <mat-icon *ngIf="loading">
                        <mat-spinner diameter="20" color="Blue"></mat-spinner>
                    </mat-icon>
                </button>
                <button [disabled]="loading 
                    || !element.Action1 
                    || Permission=='read' 
                    || EvaluationSubmitted 
                    || !EvaluationStarted
                    || AlreadyAnswered" matTooltip="submit" mat-mini-fab color="accent" (click)="SubmitEvaluation()">
                    <mat-icon>done_all</mat-icon>
                    <mat-icon *ngIf="loading">
                        <mat-spinner diameter="20" color="Blue"></mat-spinner>
                    </mat-icon>
                </button>
                <span *ngIf="ExamDurationMinutes>0" style="font-weight:bold;padding:15px">Duration:
                    {{ExamDurationMinutes}}</span>
            </mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="EvaluationPlanColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: EvaluationPlanColumns;let indx=index" class="element-row"
            style="align-items: center;"></mat-row>
    </mat-table>
    <mat-table #table [dataSource]="dataSource" *ngIf="StudentEvaluationList.length>0">
        <ng-container matColumnDef="Description">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let element" style="display:flex; flex-direction: column;justify-content: start;">
                <span style="margin:15px;width:100%">
                    {{element.AutoId}}.
                    <span *ngIf="element.QuestionnaireType=='Category' || element.QuestionnaireType=='Sub Category'"
                        style="width: 100%;padding: 15px 15px 10px 0px;font-weight: bold;">
                        {{element.Description}}</span>
                    <span *ngIf="element.QuestionnaireType=='Questionnaire'"
                        style="font-style: italic; width: 100%;padding: 15px 15px 10px 0px;">
                        {{element.Description}}</span>
                    <span style="display: flex;flex-direction: column; margin:15px 15px 15px 15px;width: 100%;"
                        *ngIf="element.ClassEvaluationAnswerOptionParentId==0 && element.QuestionnaireType=='Questionnaire'">
                        <span [innerHTML]="element.History| encodeHTML">
                        </span>
                        <mat-form-field appearance="outline" style="width:100%">
                            <textarea #input matInput [disabled]="element.AnswerOptionsId>0" [maxlength]="300"
                                (blur)="onBlur(element)" [rows]="5" [value]="element.AnswerText"
                                [(ngModel)]="element.AnswerText"></textarea>
                        </mat-form-field>
                        <mat-hint style="display:flex;justify-content: flex-end;">{{input.value?.length || 0}}/300
                        </mat-hint>
                    </span>
                    <span *ngIf="!EvaluationUpdatable && element.ClassEvaluationAnswerOptionParentId==0 && element.QuestionnaireType=='Questionnaire'">
                        <mat-form-field appearance="outline" style="width:100%">
                            <textarea #input matInput [disabled]="element.AnswerOptionsId>0" [maxlength]="1000"
                                (blur)="onBlur(element)" [value]="element.AnswerText" [rows]="5"
                                [(ngModel)]="element.AnswerText"></textarea>
                        </mat-form-field>
                        <mat-hint style="display:flex;justify-content: flex-end;">{{input.value?.length || 0}}/1000
                        </mat-hint>
                    </span>
                </span>
                <span style="margin:15px 15px 15px 100px;width:100%">
                    <span style="padding: 15px 15px 15px 0px;"
                        *ngIf="element.MultipleAnswer==1 && element.ClassEvaluationAnswerOptionParentId>0">
                        <mat-checkbox style="margin-right: 15px;"
                            *ngFor="let item of element.ClassEvaluationOptions;let i=index"
                            (click)="$event.stopPropagation()" name="options_{{i}}"
                            [value]="item.ClassEvaluationAnswerOptionsId" [checked]="item.checked"
                            (change)="UpdateAnswers(element,item,$event,i)">
                            {{item.Title}}
                        </mat-checkbox>
                    </span>
                    <span style="padding: 15px 15px 15px 0px;" *ngIf="element.ClassEvaluationAnswerOptionParentId>0 
                        && (element.MultipleAnswer==0 || element.MultipleAnswer==null)">
                        <mat-radio-group [name]="'options_'+element.ClassEvaluationId">
                            <mat-radio-button style="margin: 10px 10px 0px 0px;"
                                [name]="'options_'+element.ClassEvaluationId"
                                *ngFor="let item of element.ClassEvaluationOptions;let i=index"
                                (change)="UpdateRadio(element,item)" [value]="item.ClassEvaluationAnswerOptionsId"
                                [checked]="item.checked">
                                {{item.Title}}
                            </mat-radio-button>
                        </mat-radio-group>
                    </span>
                </span>
            </mat-cell>
        </ng-container>
        <!-- <ng-container matColumnDef="AnswerOptionsId">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let element">
                <span style="padding: 15px 15px 15px 0px;"
                    *ngIf="element.MultipleAnswer==1 && element.ClassEvaluationAnswerOptionParentId>0">
                    <mat-checkbox style="margin-right: 15px;"
                        *ngFor="let item of element.ClassEvaluationOptions;let i=index"
                        (click)="$event.stopPropagation()" name="options_{{i}}"
                        [value]="item.ClassEvaluationAnswerOptionsId" [checked]="item.checked"
                        (change)="UpdateAnswers(element,item,$event,i)">
                        {{item.Title}}
                    </mat-checkbox>
                </span>
                <span style="padding: 15px 15px 15px 0px;" *ngIf="element.ClassEvaluationAnswerOptionParentId>0 
                        && (element.MultipleAnswer==0 || element.MultipleAnswer==null)">
                    <mat-radio-group [name]="'options_'+element.ClassEvaluationId">
                        <mat-radio-button style="margin: 10px 10px 0px 0px;"
                            [name]="'options_'+element.ClassEvaluationId"
                            *ngFor="let item of element.ClassEvaluationOptions;let i=index"
                            (change)="UpdateRadio(element,item)" [value]="item.ClassEvaluationAnswerOptionsId"
                            [checked]="item.checked">
                            {{item.Title}}
                        </mat-radio-button>
                    </mat-radio-group>
                </span>
            </mat-cell>
        </ng-container> -->
        <ng-container matColumnDef="Active">
            <mat-header-cell *matHeaderCellDef style="justify-content: center;">Active
            </mat-header-cell>
            <mat-cell *matCellDef="let element" style="justify-content: center;">
                <mat-checkbox (click)="$event.stopPropagation()" (change)="UpdateActive(element,$event)"
                    [checked]="element.Active==1?true:false">
                </mat-checkbox>
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="Action">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let element" fxLayoutAlign="space-between center" fxLayout="row">
                <button [disabled]="loading || !element.Action || Permission=='read'" matTooltip="save"
                    mat-raised-button color="accent" (click)="UpdateOrSave(element)">
                    <mat-icon>save</mat-icon>
                    <mat-icon *ngIf="loading">
                        <mat-spinner diameter="20" color="Blue"></mat-spinner>
                    </mat-icon>
                </button>
            </mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;let indx=index" class="element-row"
            style="align-items: center;"></mat-row>
    </mat-table>
    <mat-paginator style="display:flex;justify-content:center" [pageSizeOptions]="[1,5,10,20]"></mat-paginator>
</div>